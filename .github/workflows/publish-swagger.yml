name: Publish Swagger to GitHub Pages

on:
    push:
        branches: [ backend ]   # 필요시 main 등으로 변경
    workflow_dispatch:

jobs:
    build-and-publish:
        runs-on: ubuntu-latest

        env:
            SPRING_PROFILES_ACTIVE: openapi
            # 앱이 부팅될 때 필요한 환경변수들(예: JWT_SECRET 등) 미리 주입
            JWT_SECRET: ci-test-secret-please-replace

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: '21'

            - name: Grant execute permission for Gradle
              run: chmod +x ./gradlew

            - name: Build (compile only)
              run: ./gradlew --no-daemon clean classes

            # springdoc Gradle 플러그인이 앱을 띄우고 /v3/api-docs.yaml을 수집하여 파일 생성
            - name: Generate OpenAPI spec
              run: ./gradlew --no-daemon generateOpenApiDocs

            - name: Prepare static Swagger UI
              run: |
                  mkdir -p public
                  cp build/openapi/openapi.yaml public/
                  # GitHub Pages에서 Jekyll 간섭 방지
                  touch public/.nojekyll
                  cat > public/index.html <<'EOF'
                  <!doctype html>
                  <html>
                  <head>
                    <meta charset="utf-8"/>
                    <meta name="viewport" content="width=device-width, initial-scale=1"/>
                    <title>ItDaIng API Docs</title>
                    <link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist/swagger-ui.css">
                  </head>
                  <body>
                    <div id="swagger-ui"></div>
                    <script src="https://unpkg.com/swagger-ui-dist/swagger-ui-bundle.js"></script>
                    <script>
                      window.onload = () => {
                        window.ui = SwaggerUIBundle({
                          url: './openapi.yaml',
                          dom_id: '#swagger-ui',
                          presets: [SwaggerUIBundle.presets.apis],
                        });
                      };
                    </script>
                  </body>
                  </html>
                  EOF

            - name: Deploy to GitHub Pages (gh-pages)
              uses: peaceiris/actions-gh-pages@v3
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  publish_dir: ./public
                  publish_branch: gh-pages
